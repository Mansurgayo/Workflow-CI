name: MLflow Skilled CI

on:
  push:
    branches: [ main ]

jobs:
  mlflow-skilled:
    runs-on: ubuntu-latest

    steps:
      # 1. Set up job
      - name: Set up job
        run: echo "üöÄ MLflow Skilled CI Job started"

      # 2. Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 3. Set up Python 3.12.7
      - name: Set up Python 3.12.7
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.7'

      # 4. Check environment
      - name: Check environment
        run: |
          python --version
          pip --version
          which python
          which pip
          pip list

      # 5. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow scikit-learn pandas matplotlib seaborn gdown

      # 6. Set MLflow Tracking URI
      - name: Set MLflow Tracking URI
        run: |
          python -c "import mlflow; mlflow.set_tracking_uri('./mlruns'); print('‚úÖ MLflow Tracking URI set to ./mlruns')"
        working-directory: ./MLProject

      # 7. Run MLflow project
      - name: Run MLflow project
        working-directory: ./MLProject
        run: |
          if [ -f ./dataset/cleaned_dataset.csv ]; then
            echo "‚úÖ Dataset ditemukan"
            mlflow run . \
              --env-manager=local \
              --experiment-name Workflow_CI_Experiment \
              -e train \
              -P data_path=dataset/cleaned_dataset.csv || exit 1
          else
            echo "‚ùå Dataset tidak ditemukan, workflow gagal"
            exit 1
          fi

      # 8. Install additional Python dependencies
      - name: Install additional Python dependencies
        run: |
          pip install requests numpy

      # 9. Upload to Google Drive
      - name: Upload MLflow artifacts to Google Drive
        run: |
          mkdir -p drive_upload
          cp -r MLProject/mlruns drive_upload/
          # Gunakan gdown/rclone untuk upload ke Drive

      # 10. Post Python setup
      - name: Post Python setup
        run: echo "‚úÖ Post Python setup completed"

      # 11. Post Checkout cleanup
      - name: Post Checkout cleanup
        run: echo "‚úÖ Post checkout completed"

      # 12. Complete job
      - name: Complete job
        run: echo "üéØ MLflow Skilled CI Job completed"
