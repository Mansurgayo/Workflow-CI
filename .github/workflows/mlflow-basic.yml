name: MLflow Basic CI

on:
  push:
    branches: [ main ]

jobs:
  mlflow-basic:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Set up job
    - name: Set up job
      run: echo "Starting MLflow job"
    
    # 2. Run actions/checkout@v3
    - name: Checkout code
      uses: actions/checkout@v3
    
    # 3. Set up Python 3.12.7
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
    
    # 4. Check Env
    - name: Check Environment
      run: |
        python --version
        echo "Directory: $(pwd)"
        ls -la
        echo "Cek file conda.yaml:"
        find . -name "conda.yaml" -o -name "environment.yml"
        echo "Isi conda.yaml:"
        cat conda.yaml
    
    # 5. Install dependencies
    - name: Install dependencies
      run: |
        pip install mlflow
    
    # 6. Run mlflow project
    - name: Run mlflow project
      run: |
        # Buat MLproject yang pakai conda.yaml
        echo "name: diabetes_mlflow" > MLproject
        echo "conda_env: conda.yaml" >> MLproject
        echo "entry_points:" >> MLproject
        echo "  main:" >> MLproject
        echo "    command: \"python modelling.py\"" >> MLproject
        
        echo "MLproject content:"
        cat MLproject
        echo "Conda file exists:"
        ls -la conda.yaml
        
        mlflow run . --env-manager=local
    
    # 7. Get latest MLflow run_id
    - name: Get latest MLflow run_id
      run: |
        echo "Latest run:"
        find ./mlruns -name "meta.yaml" | head -1