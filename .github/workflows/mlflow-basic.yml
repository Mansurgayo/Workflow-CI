name: MLflow Skilled CI

on:
  push:
    branches: [ main ]

jobs:
  mlflow-skilled:
    runs-on: ubuntu-latest

    steps:
    # 1. Set up job
    - name: Set up job
      run: echo "ðŸš€ MLflow Skilled CI Job started"

    # 2. Run actions/checkout@v3
    - name: Checkout code
      uses: actions/checkout@v3

    # 3. Set up Python 3.12.7
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'

    # 4. Check Env
    - name: Check environment
      run: |
        python --version
        pip --version
        which python
        which pip
        pip list

    # 5. Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mlflow scikit-learn pandas matplotlib seaborn gdown

    # 6. Set MLflow Tracking URI (perbaikan)
    - name: Set MLflow Tracking URI
      run: |
        python -c "import mlflow; mlflow.set_tracking_uri('./MLProject/mlruns'); print('âœ… MLflow Tracking URI set to ./MLProject/mlruns')"

    # 7. Run MLflow project
    - name: Run MLflow project
      run: |
        mlflow run MLProject \
          --env-manager=local \
          --experiment-name Workflow_CI_Experiment \
          -P data_path=data/dataset.csv || exit 1

    # 8. Install Python dependencies (opsional tambahan)
    - name: Install additional Python dependencies
      run: |
        pip install requests numpy

    # 9. Upload to Google Drive
    - name: Upload MLflow artifacts to Google Drive
      run: |
        mkdir -p drive_upload
        cp -r MLProject/mlruns drive_upload/
        # Gunakan gdown/rclone untuk upload ke Drive

    # 10. Post Set up Python 3.12.7
    - name: Post Python 3.12.7 setup
      run: echo "âœ… Post Python setup completed"

    # 11. Post Run actions/checkout@v3
    - name: Post Checkout cleanup
      run: echo "âœ… Post checkout completed"

    # 12. Complete job
    - name: Complete job
      run: echo "ðŸŽ¯ MLflow Skilled CI Job completed"
