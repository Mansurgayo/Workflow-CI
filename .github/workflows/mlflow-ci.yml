name: MLflow Training Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  mlflow-training:
    runs-on: ubuntu-latest
    
    steps:
    # Set up job
    - name: Set up job
      run: echo "Starting MLflow training job..."
    
    # Run actions/checkout@v3
    - name: Checkout code
      uses: actions/checkout@v3
    
    # Set up Python 3.12.7
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
        cache: 'pip'
    
    # Check Env
    - name: Check Environment
      run: |
        python --version
        pip --version
        echo "Current directory: $(pwd)"
        ls -la
    
    # Install dependencies
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
    
    # Install Python dependencies
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install mlflow boto3 google-cloud-storage
    
    # Set MLflow Tracking URI
    - name: Set MLflow Tracking URI
      run: |
        if [ -n "${{ secrets.MLFLOW_TRACKING_URI }}" ]; then
          echo "MLFLOW_TRACKING_URI=${{ secrets.MLFLOW_TRACKING_URI }}" >> $GITHUB_ENV
        else
          echo "MLFLOW_TRACKING_URI=file:///$(pwd)/mlruns" >> $GITHUB_ENV
        fi
        echo "Tracking URI: $MLFLOW_TRACKING_URI"
    
    # Run mlflow project
    - name: Run MLflow project
      run: |
        mlflow run . \
          --experiment-name "github-actions-experiment" \
          --env-manager local
      env:
        MLFLOW_TRACKING_URI: ${{ env.MLFLOW_TRACKING_URI }}
    
    # Upload to Google Drive
    - name: Upload to Google Drive
      run: |
        # Install rclone
        curl https://rclone.org/install.sh | sudo bash
        
        # Create rclone config directory
        mkdir -p ~/.config/rclone
        
        # Configure rclone dengan service account (gunakan secrets)
        echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
        
        # Create timestamp for folder name
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        
        # Upload mlruns directory to Google Drive
        rclone copy ./mlruns/ mydrive:/mlflow-experiments/${{ github.repository }}/run_${TIMESTAMP}_${{ github.run_id }}/ -v
        
        echo "Upload completed to Google Drive"
    
    # Post Set up Python 3.12.7
    - name: Post Python setup cleanup
      if: always()
      run: echo "Cleaning up Python environment..."
    
    # Post Run actions/checkout@v3  
    - name: Post checkout cleanup
      if: always()
      run: echo "Cleaning up checkout files..."
    
    # Complete job
    - name: Complete job
      if: always()
      run: |
        echo "Job completed with status: ${{ job.status }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "See results in Google Drive"