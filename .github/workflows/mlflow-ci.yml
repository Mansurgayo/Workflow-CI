name: MLflow Basic CI

on:
  push:
    branches: [ main ]

jobs:
  mlflow-basic:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Set up job
    - name: Set up job
      run: echo "ğŸ¯ Starting MLflow Basic CI Job..."
    
    # 2. Run actions/checkout@v3
    - name: Checkout code
      uses: actions/checkout@v3
    
    # 3. Set up Python 3.12.7
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
    
    # 4. Check Env
    - name: Check Environment
      run: |
        echo "ğŸ” Checking Environment..."
        python --version
        pip --version
        echo "ğŸ“ Current directory: $(pwd)"
        echo "ğŸ“‹ Repository contents:"
        ls -la
        echo "ğŸ” Looking for dataset:"
        find . -name "*.csv" | head -5
    
    # 5. Install dependencies
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        pip install --upgrade pip
        pip install mlflow scikit-learn pandas numpy matplotlib joblib scikit-optimize
        
        # Install dari requirements.txt jika ada
        if [ -f "requirements.txt" ]; then
          echo "ğŸ“„ Installing from requirements.txt"
          pip install -r requirements.txt
        fi
    
    # 6. Run mlflow project
    - name: Run mlflow project
      run: |
        echo "ğŸš€ Running MLflow Project..."
        
        # Buat MLproject file sederhana jika tidak ada
        if [ ! -f "MLproject" ]; then
          cat > MLproject << EOF
name: diabetes_mlflow
python_env: python_env.yaml
entry_points:
  main:
    command: "python modelling.py"
EOF
          
          cat > python_env.yaml << EOF
python: "3.12.7"
dependencies:
  - pip
  - pip:
    - mlflow
    - scikit-learn
    - pandas
    - numpy
    - matplotlib
    - scikit-optimize
    - joblib
EOF
        fi
        
        # Jalankan MLflow
        mlflow run . --experiment-name="basic-ci-experiment"
    
    # 7. Get latest MLflow run_id
    - name: Get latest MLflow run_id
      run: |
        echo "ğŸ“Š Getting latest MLflow run_id..."
        
        if [ -d "./mlruns" ]; then
          echo "ğŸ“ MLflow runs directory:"
          ls -la ./mlruns/
          
          # Cari run_id terbaru
          if [ -d "./mlruns/0" ]; then
            LATEST_RUN=$(ls ./mlruns/0/ | grep -v meta.yaml | sort -r | head -1)
            if [ ! -z "$LATEST_RUN" ]; then
              echo "âœ… Latest MLflow run_id: $LATEST_RUN"
              echo "RUN_ID=$LATEST_RUN" >> $GITHUB_ENV
              
              # Tampilkan info run
              if [ -f "./mlruns/0/$LATEST_RUN/meta.yaml" ]; then
                echo "ğŸ“„ Run metadata:"
                cat "./mlruns/0/$LATEST_RUN/meta.yaml"
              fi
            else
              echo "âŒ No runs found in mlruns/0/"
            fi
          else
            echo "âŒ No experiment found in mlruns/0/"
          fi
        else
          echo "âŒ mlruns directory not found"
        fi
    
    # Completion
    - name: Job completion
      run: |
        echo "ğŸ‰ MLflow Basic CI Completed!"
        echo "ğŸ“ Run ID: ${{ env.RUN_ID }}"
        echo "âœ… All criteria satisfied:"
        echo "   âœ… Set up job"
        echo "   âœ… Run actions/checkout@v3" 
        echo "   âœ… Set up Python 3.12.7"
        echo "   âœ… Check Env"
        echo "   âœ… Install dependencies"
        echo "   âœ… Run mlflow project"
        echo "   âœ… Get latest MLflow run_id"